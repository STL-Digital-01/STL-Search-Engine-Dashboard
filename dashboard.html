<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(180deg,#0f172a 0%, #071129 55%);
      color: #e6eef8;
      font-family: sans-serif;
      min-height: 100vh;
      padding: 2rem;
    }
    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 0.75rem;
      padding: 1rem;
    }
    .metric-list li {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <main class="max-w-5xl mx-auto space-y-8">
    <header class="text-center">
  <h1 id="dashboardTitle" class="text-4xl font-bold tracking-tight transition-all duration-300"> Dashboard</h1>
  <p id="dashboardSubtitle" class="text-slate-300 mt-2 text-lg">IRR data overview</p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="glass flex flex-col gap-4">
        <h2 class="text-sm text-slate-300 mb-2">IRR Key Metrics</h2>
        <div id="irrMetricCards" class="grid grid-cols-2 gap-4"></div>
        <div>
          <h3 class="text-sm text-slate-300 mb-2">Extra Metrics</h3>
          <div id="extraMetricCards" class="grid grid-cols-2 gap-4"></div>
        </div>
      </div>
      <div class="glass flex flex-col gap-4">
        <h3 class="text-sm text-slate-300 mb-2">Summary Table <span class="text-xs text-blue-300">(click to sort)</span></h3>
        <table class="w-full text-left border-collapse border border-white/20" id="irrTable">
          <thead>
            <tr>
              <th class="border border-white/20 px-4 py-2 cursor-pointer" id="sortLabel">Label/Year</th>
              <th class="border border-white/20 px-4 py-2 cursor-pointer" id="sortIRR">IRR (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="mt-2 text-xs text-slate-400" id="lastUpdated"></div>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
      <div class="glass card col-span-1 md:col-span-3 animate-fadein">
        <h3 class="text-lg mb-3">IRR Radar Chart</h3>
        <canvas id="irrRadarChart"></canvas>
      </div>
      <div class="glass card col-span-1 animate-fadein">
        <h3 class="text-lg mb-3">IRR Line Chart</h3>
        <canvas id="irrLineChart"></canvas>
      </div>
      <div class="glass card col-span-1 animate-fadein">
        <h3 class="text-lg mb-3">IRR Donut Chart</h3>
        <canvas id="irrDonutChart"></canvas>
      </div>
    </section>

    <section id="vendorSection" class="mt-8">
      <!-- Vendor cards will be rendered here dynamically -->
    </section>
  </main>

  <script>

  let radarChart, lineChart, donutChart;
    const colors = ["#60a5fa","#f472b6","#34d399","#facc15","#a78bfa","#fb7185","#38bdf8","#fbbf24","#a3e635","#f87171"];
    function renderDashboard(irrData) {
      // Dynamic title/subtitle
      const titleEl = document.getElementById('dashboardTitle');
      const subtitleEl = document.getElementById('dashboardSubtitle');
      let title = 'Dashboard';
      let subtitle = 'IRR data overview';
      if (irrData.some(d => d.label && d.label.toLowerCase().includes('lead silver recovery'))) {
        title = 'Lead Silver Recovery Project IRR';
        subtitle = 'Varying IRRs for Lead Silver Recovery';
      } else if (irrData.some(d => d.label && d.label.toLowerCase().includes('fumer'))) {
        title = 'Fumer Project IRR';
        subtitle = 'IRR for Fumer Technology';
      } else if (irrData.some(d => d.year)) {
        title = 'STL IRR Over Years';
        subtitle = 'Year-wise IRR breakdown';
      }
      titleEl.textContent = title;
      subtitleEl.textContent = subtitle;

      // Animated metric cards for IRR values
      const irrMetricCards = document.getElementById('irrMetricCards');
      irrMetricCards.innerHTML = irrData.map((d, i) => {
        let value = (typeof d === 'object' && d !== null) ? d.irr : d;
        let label = (typeof d === 'object' && d !== null) ? (d.year ? `Year ${d.year}` : (d.label ? d.label : `Value ${i+1}`)) : `Value ${i+1}`;
        let icon = '<span class="metric-icon">ðŸ“ˆ</span>';
        return `<div class="metric-card animate-fadein">${icon}<div><div>${label}</div><div>${value}</div></div></div>`;
      }).join('');

      // Extra Metrics as cards
      const validIrrs = irrData.map(d => (typeof d === 'object' && d !== null) ? parseFloat(d.irr) : parseFloat(d)).filter(n => !isNaN(n));
      const avg = validIrrs.length ? (validIrrs.reduce((a,b)=>a+b,0)/validIrrs.length).toFixed(4) : '-';
      const max = validIrrs.length ? Math.max(...validIrrs).toFixed(4) : '-';
      const min = validIrrs.length ? Math.min(...validIrrs).toFixed(4) : '-';
      let growth = '-';
      if (validIrrs.length > 1) {
        const first = validIrrs[0], last = validIrrs[validIrrs.length-1];
        growth = (((last-first)/Math.abs(first))*100).toFixed(2) + '%';
      }
      document.getElementById('extraMetricCards').innerHTML = `
        <div class="metric-card animate-fadein"><span class="metric-icon">ðŸ§®</span>Average IRR: <span class="text-yellow-300">${avg !== '-' ? avg + '%' : '-'}</span></div>
        <div class="metric-card animate-fadein"><span class="metric-icon">ðŸš€</span>Highest IRR: <span class="text-green-300">${max !== '-' ? max + '%' : '-'}</span></div>
        <div class="metric-card animate-fadein"><span class="metric-icon">ðŸ“‰</span>Lowest IRR: <span class="text-red-300">${min !== '-' ? min + '%' : '-'}</span></div>
        <div class="metric-card animate-fadein"><span class="metric-icon">ðŸ“Š</span>Growth Rate: <span class="text-blue-300">${growth}</span></div>
      `;

      // Sortable summary table
      const labels = irrData.map((d, i) => {
        if (typeof d === 'object' && d !== null) {
          if (d.year) return `Year ${d.year}`;
          if (d.label) return d.label;
          return `Value ${i+1}`;
        } else {
          return `Value ${i+1}`;
        }
      });
      const tbody = document.getElementById('irrTable').querySelector('tbody');
      tbody.innerHTML = '';
      irrData.forEach((d, i) => {
        let value = (typeof d === 'object' && d !== null) ? d.irr : d;
        let label = labels[i];
        tbody.innerHTML += `<tr><td class="border border-white/20 px-4 py-2">${label}</td><td class="border border-white/20 px-4 py-2">${value}</td></tr>`;
      });

      // Last Updated Timestamp
      const lastUpdatedEl = document.getElementById('lastUpdated');
      const now = new Date();
      lastUpdatedEl.textContent = `Last Updated: ${now.toLocaleString()}`;

      // Radar Chart
      if(radarChart) radarChart.destroy();
      radarChart = new Chart(document.getElementById('irrRadarChart'), {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: 'IRR (%)',
            data: labels.map((_, i) => {
              let value = (typeof irrData[i] === 'object' && irrData[i] !== null) ? irrData[i].irr : irrData[i];
              let num = parseFloat(value);
              return (value !== null && value !== undefined && !isNaN(num)) ? num : 0;
            }),
            backgroundColor: 'rgba(96,165,250,0.15)',
            borderColor: '#60a5fa',
            pointBackgroundColor: colors,
            pointBorderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e6eef8' } } },
          scales: {
            r: {
              angleLines: { color: '#334155' },
              grid: { color: '#334155' },
              pointLabels: { color: '#e6eef8', font: { size: 14 } },
              ticks: { color: '#e6eef8', beginAtZero: true }
            }
          }
        }
      });

      // Line Chart
      if(lineChart) lineChart.destroy();
      lineChart = new Chart(document.getElementById('irrLineChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'IRR (%)',
            data: labels.map((_, i) => {
              let value = (typeof irrData[i] === 'object' && irrData[i] !== null) ? irrData[i].irr : irrData[i];
              let num = parseFloat(value);
              return (value !== null && value !== undefined && !isNaN(num)) ? num : 0;
            }),
            fill: false,
            borderColor: '#34d399',
            backgroundColor: 'rgba(52,211,153,0.2)',
            tension: 0.3,
            pointBackgroundColor: colors,
            pointBorderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e6eef8' } } },
          scales: {
            x: { ticks: { color: '#e6eef8' }, grid: { color: '#334155' } },
            y: { ticks: { color: '#e6eef8' }, grid: { color: '#334155' }, beginAtZero: true }
          }
        }
      });

      // Donut Chart
      if(donutChart) donutChart.destroy();
      donutChart = new Chart(document.getElementById('irrDonutChart'), {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            label: 'IRR (%)',
            data: labels.map((_, i) => {
              let value = (typeof irrData[i] === 'object' && irrData[i] !== null) ? irrData[i].irr : irrData[i];
              let num = parseFloat(value);
              return (value !== null && value !== undefined && !isNaN(num)) ? num : 0;
            }),
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e6eef8' } } }
        }
      });

      // Vendor cards
      const vendorSection = document.getElementById('vendorSection');
      vendorSection.innerHTML = '';
      let vendorData = [];
      try {
        vendorData = JSON.parse(localStorage.getItem('vendorData') || '[]');
      } catch(e) {}
      if (Array.isArray(vendorData) && vendorData.length) {
        vendorSection.innerHTML = '<h2 class="text-xl font-bold mb-4 text-blue-300">Vendors</h2>' + vendorData.map(v => `
          <div class="vendor-card animate-fadein">
            <div class="font-bold text-lg">${v.name || 'Vendor'}</div>
            <div class="text-sm">${v.role ? `<span class='font-semibold'>Role:</span> ${v.role}` : ''}</div>
            <div class="text-sm">${v.price ? `<span class='font-semibold'>Price:</span> ${v.price}` : ''}</div>
            <div class="text-sm">${v.rationale ? `<span class='font-semibold'>Rationale:</span> ${v.rationale}` : ''}</div>
          </div>
        `).join('');
      }
    }

    // Assume irrValues is loaded from localStorage
    function renderIRRValues() {
      const irrValues = JSON.parse(localStorage.getItem('irrValues') || '[]');
      const container = document.getElementById('irr-list');
      if (!container) return;
      container.innerHTML = '';
      let count = 1;
      irrValues.forEach(v => {
        let label = '';
        if (v.year) {
          label = `Year ${v.year}: ${v.irr}%`;
        } else if (v.label) {
          label = `${v.label}: ${v.irr}%`;
        } else {
          label = `Value ${count}: ${v.irr}%`;
          count++;
        }
        const div = document.createElement('div');
        div.textContent = label;
        container.appendChild(div);
      });
    }

  // On load, try to read IRR data from localStorage
  let irrDataReceived = false;
  let currentSort = { col: null, asc: true };
  function updateDashboardFromStorage() {
    const storedIrr = localStorage.getItem('irrValues');
    if (storedIrr) {
      try {
        const irrArray = JSON.parse(storedIrr);
        if (Array.isArray(irrArray) && irrArray.length) {
          irrDataReceived = true;
          renderDashboard(irrArray);
        }
      } catch(e) { console.error('Failed to parse IRR data from localStorage', e); }
    }
    if (!irrDataReceived) {
      document.getElementById('irrMetricCards').innerHTML = '<div class="metric-card">Waiting for IRR data...</div>';
      document.getElementById('extraMetricCards').innerHTML = '';
      const ctx = document.getElementById('irrRadarChart').getContext('2d');
      ctx.clearRect(0,0,400,200);
    }
  }
  updateDashboardFromStorage();
  // Listen for localStorage changes (auto-update dashboard)
  window.addEventListener('storage', function(event) {
    if (event.key === 'irrValues') {
      updateDashboardFromStorage();
    }
  });
  // Sort table columns
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('sortLabel').addEventListener('click', () => {
      sortTable('label');
    });
    document.getElementById('sortIRR').addEventListener('click', () => {
      sortTable('irr');
    });
  });
  function sortTable(col) {
    const storedIrr = localStorage.getItem('irrValues');
    if (!storedIrr) return;
    let irrArray = JSON.parse(storedIrr);
    if (col === currentSort.col) currentSort.asc = !currentSort.asc;
    else currentSort = { col, asc: true };
    irrArray.sort((a, b) => {
      if (col === 'label') {
        const labelA = a.year ? `Year ${a.year}` : (a.label || '');
        const labelB = b.year ? `Year ${b.year}` : (b.label || '');
        return currentSort.asc ? labelA.localeCompare(labelB) : labelB.localeCompare(labelA);
      } else if (col === 'irr') {
        const numA = parseFloat(a.irr);
        const numB = parseFloat(b.irr);
        return currentSort.asc ? numA - numB : numB - numA;
      }
      return 0;
    });
    renderDashboard(irrArray);
  }
  </script>
</body>
</html>
