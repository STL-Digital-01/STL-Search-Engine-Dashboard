<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(180deg,#0f172a 0%, #071129 55%);
      color: #e6eef8;
      font-family: sans-serif;
      min-height: 100vh;
      padding: 2rem;
    }
    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 0.75rem;
      padding: 1rem;
    }
    .metric-list li {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <main class="max-w-5xl mx-auto space-y-8">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between text-center md:text-left">
      <div>
        <h1 id="dashboardTitle" class="text-4xl font-bold tracking-tight transition-all duration-300"> Dashboard</h1>
        <p id="dashboardSubtitle" class="text-slate-300 mt-2 text-lg"> data overview</p>
      </div>
      <div class="flex gap-4 justify-center md:justify-end mt-4 md:mt-0">
        <button id="downloadPdfBtn" title="Download PDF" class="bg-white/10 hover:bg-blue-600 text-blue-300 hover:text-white rounded-full p-3 shadow-lg transition-all flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          <span class="hidden md:inline">Download PDF</span>
        </button>
        <button id="pushBiBtn" title="Push BI Dashboard" class="bg-white/10 hover:bg-green-600 text-green-300 hover:text-white rounded-full p-3 shadow-lg transition-all flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg>
          <span class="hidden md:inline">Push BI Dashboard</span>
        </button>
        <button id="previewPdfBtn" title="Preview PDF" class="bg-white/10 hover:bg-sky-600 text-sky-300 hover:text-white rounded-full p-3 shadow-lg transition-all flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
          <span class="hidden md:inline">Preview</span>
        </button>
        <button id="shareBtnSimple" title="Share PDF" class="bg-white/10 hover:bg-indigo-600 text-indigo-300 hover:text-white rounded-full p-3 shadow-lg transition-all flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
          <span class="hidden md:inline">Share</span>
        </button>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="glass flex flex-col gap-4">
        <h2 class="text-sm text-slate-300 mb-2"> Key Metrics</h2>
        <div id="irrMetricCards" class="grid grid-cols-2 gap-4"></div>
        <div>
          <h3 class="text-sm text-slate-300 mb-2">Extra Metrics</h3>
          <div id="extraMetricCards" class="grid grid-cols-2 gap-4"></div>
        </div>
      </div>
      <div class="glass flex flex-col gap-4">
        <h3 class="text-sm text-slate-300 mb-2">Summary Table <span class="text-xs text-blue-300">(click to sort)</span></h3>
        <table class="w-full text-left border-collapse border border-white/20" id="irrTable">
          <thead>
            <tr>
              <th class="border border-white/20 px-4 py-2 cursor-pointer" id="sortLabel">Label/Year</th>
               <th class="border border-white/20 px-4 py-2 cursor-pointer" id="sortIRR">Value (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="mt-2 text-xs text-slate-400" id="lastUpdated"></div>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
      <div class="glass card col-span-1 md:col-span-3 animate-fadein">
          <h3 class="text-lg mb-3">  Bar Chart</h3>
        <canvas id="irrRadarChart"></canvas>
      </div>
      <div class="glass card col-span-1 animate-fadein">
          <h3 class="text-lg mb-3">  Line Chart</h3>
        <canvas id="irrLineChart"></canvas>
      </div>
      <div class="glass card col-span-1 animate-fadein">
          <h3 class="text-lg mb-3">  Donut Chart</h3>
        <canvas id="irrDonutChart"></canvas>
      </div>
    </section>

    <section id="vendorSection" class="mt-8">
      <!-- Vendor cards will be rendered here dynamically -->
    </section>
  </main>

  <script>

    // Make webhook constants (client-side send)
    const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/w74s2h3fbypn8e7x6i7msitnx17ybglb";
    const MAKE_API_KEY = "super-secret-12345";

    // cached PDF blob to avoid re-generating multiple times
    let cachedPdfBlob = null;
    async function ensurePdfBlob() {
      if (cachedPdfBlob) return cachedPdfBlob;
      // generate PDF using html2pdf and return a Blob
      await import('https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js');
      const opt = { margin: 0.5, filename: 'dashboard.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
      // html2pdf returns a promise via node.js style; we convert to a Blob via output('blob')
      return new Promise((resolve, reject) => {
        try {
          html2pdf().set(opt).from(document.body).output('blob').then(blob => {
            cachedPdfBlob = blob;
            resolve(blob);
          }).catch(reject);
        } catch (e) { reject(e); }
      });
    }

    // Simple Share modal (insert near other modal logic)
    const simpleShareModalHtml = `
      <div id="simpleShareModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
        <div class="bg-white/5 p-6 rounded shadow-lg w-full max-w-lg glass">
          <h3 class="text-xl mb-2">Share Dashboard (PDF)</h3>
          <div class="space-y-2">
            <label class="block text-sm">To (comma-separated)</label>
            <input id="simpleTo" class="w-full p-2 rounded bg-white/5" />
            <label class="block text-sm">CC (optional)</label>
            <input id="simpleCc" class="w-full p-2 rounded bg-white/5" />
            <label class="block text-sm">Subject</label>
            <input id="simpleSubject" class="w-full p-2 rounded bg-white/5" value="Shared Dashboard" />
            <div id="simpleShareStatus" class="text-sm text-yellow-300"></div>
            <div class="flex justify-end gap-2 mt-4">
              <button id="simpleShareCancel" class="px-4 py-2 rounded bg-gray-600">Cancel</button>
              <button id="simpleShareSend" class="px-4 py-2 rounded bg-indigo-600 text-white">Send</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', simpleShareModalHtml);
    const simpleShareModal = document.getElementById('simpleShareModal');
    const simpleTo = document.getElementById('simpleTo');
    const simpleCc = document.getElementById('simpleCc');
    const simpleSubject = document.getElementById('simpleSubject');
    const simpleShareStatus = document.getElementById('simpleShareStatus');
    const simpleShareSend = document.getElementById('simpleShareSend');
    const simpleShareCancel = document.getElementById('simpleShareCancel');

    document.getElementById('shareBtnSimple').addEventListener('click', () => {
      simpleShareModal.classList.remove('hidden'); simpleShareModal.classList.add('flex');
      simpleShareStatus.textContent = '';
    });
    simpleShareCancel.addEventListener('click', () => { simpleShareModal.classList.remove('flex'); simpleShareModal.classList.add('hidden'); });

    simpleShareSend.addEventListener('click', async () => {
      simpleShareStatus.textContent = 'Preparing PDF...';
      try {
        const blob = await ensurePdfBlob();
        if (!blob) throw new Error('Failed to generate PDF');
        simpleShareStatus.textContent = 'Uploading to Make...';
        const form = new FormData();
        form.append('dashboard', blob, 'dashboard.pdf');
        form.append('to', simpleTo.value || '');
        form.append('cc', simpleCc.value || '');
        form.append('subject', simpleSubject.value || 'Shared Dashboard');

        const headers = { 'x-make-apikey': MAKE_API_KEY };
        const resp = await fetch(MAKE_WEBHOOK_URL, { method: 'POST', headers, body: form });
        const text = await resp.text();
        if (resp.ok) {
          simpleShareStatus.textContent = 'Shared via Make webhook.';
          setTimeout(() => { simpleShareModal.classList.remove('flex'); simpleShareModal.classList.add('hidden'); }, 1200);
        } else {
          simpleShareStatus.textContent = 'Make webhook failed: ' + (text || resp.statusText);
        }
      } catch (e) {
        console.error('Share failed', e);
        simpleShareStatus.textContent = 'Share failed: ' + (e && e.message ? e.message : e);
      }
    });

    // Preview modal (shows cached PDF and allows download/share)
    const previewHtml = `
      <div id="previewModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
        <div class="bg-white/5 p-4 rounded shadow-lg w-full max-w-4xl glass">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg">PDF Preview</h3>
            <div class="flex gap-2">
              <button id="previewDownload" class="px-3 py-1 rounded bg-white/10">Download</button>
              <button id="previewShare" class="px-3 py-1 rounded bg-indigo-600 text-white">Share</button>
              <button id="previewClose" class="px-3 py-1 rounded bg-gray-600">Close</button>
            </div>
          </div>
          <div style="height:70vh;">
            <object id="pdfPreviewObject" type="application/pdf" width="100%" height="100%">Your browser does not support inline PDF preview.</object>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', previewHtml);
    const previewModal = document.getElementById('previewModal');
    const pdfPreviewObject = document.getElementById('pdfPreviewObject');
    const previewDownload = document.getElementById('previewDownload');
    const previewShare = document.getElementById('previewShare');
    const previewClose = document.getElementById('previewClose');

    document.getElementById('previewPdfBtn').addEventListener('click', async () => {
      previewModal.classList.remove('hidden'); previewModal.classList.add('flex');
      try {
        const blob = await ensurePdfBlob();
        const url = URL.createObjectURL(blob);
        pdfPreviewObject.data = url;
        // set download link
        previewDownload.onclick = () => { const a = document.createElement('a'); a.href = url; a.download = 'dashboard.pdf'; document.body.appendChild(a); a.click(); a.remove(); };
        // share opens the simple share modal and ensures the pdf is cached
        previewShare.onclick = () => { simpleShareModal.classList.remove('hidden'); simpleShareModal.classList.add('flex'); simpleShareStatus.textContent = ''; };
      } catch (e) {
        console.error('Preview failed', e);
      }
    });
    previewClose.addEventListener('click', () => { previewModal.classList.remove('flex'); previewModal.classList.add('hidden'); });


    // PDF download logic
    document.addEventListener('DOMContentLoaded', function() {
      const pdfBtn = document.getElementById('downloadPdfBtn');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', function() {
          import('https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js').then(() => {
            html2pdf(document.body, {
              margin: 0.5,
              filename: 'dashboard.pdf',
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            });
          });
        });
      }
      // Push BI Dashboard logic (fullscreen)
      const biBtn = document.getElementById('pushBiBtn');
      if (biBtn) {
        biBtn.addEventListener('click', function() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
          } else {
            document.exitFullscreen();
          }
        });
      }
    });

  let radarChart, lineChart, donutChart;
    const colors = ["#60a5fa","#f472b6","#34d399","#facc15","#a78bfa","#fb7185","#38bdf8","#fbbf24","#a3e635","#f87171"];
    function renderDashboard(irrData) {
      // Dynamic title/subtitle
      const titleEl = document.getElementById('dashboardTitle');
      const subtitleEl = document.getElementById('dashboardSubtitle');
      let title = 'Dashboard';
      let subtitle = ' data overview';
      if (irrData.some(d => d.label && d.label.toLowerCase().includes('lead silver recovery'))) {
        title = 'Lead Silver Recovery Project ';
        subtitle = 'Varying  for Lead Silver Recovery';
      } else if (irrData.some(d => d.label && d.label.toLowerCase().includes('fumer'))) {
        title = 'Fumer Project ';
        subtitle = ' for Fumer Technology';
      } else if (irrData.some(d => d.year)) {
        title = 'STL  Over Years';
        subtitle = 'Year-wise breakdown';
      }
      titleEl.textContent = title;
      subtitleEl.textContent = subtitle;

      // Animated metric cards for IRR values
      const irrMetricCards = document.getElementById('irrMetricCards');
      irrMetricCards.innerHTML = irrData.map((d, i) => {
        let value = (typeof d === 'object' && d !== null) ? d.irr : d;
        let label = (typeof d === 'object' && d !== null) ? (d.year ? `Year ${d.year}` : (d.label ? d.label : `Value ${i+1}`)) : `Value ${i+1}`;
        let icon = '<span class="metric-icon">📈</span>';
        return `<div class="metric-card animate-fadein">${icon}<div><div>${label}</div><div>${value}</div></div></div>`;
      }).join('');

      // Extra Metrics as cards
      const validIrrs = irrData.map(d => (typeof d === 'object' && d !== null) ? parseFloat(d.irr) : parseFloat(d)).filter(n => !isNaN(n));
      const avg = validIrrs.length ? (validIrrs.reduce((a,b)=>a+b,0)/validIrrs.length).toFixed(4) : '-';
      const max = validIrrs.length ? Math.max(...validIrrs).toFixed(4) : '-';
      const min = validIrrs.length ? Math.min(...validIrrs).toFixed(4) : '-';
      let growth = '-';
      if (validIrrs.length > 1) {
        const first = validIrrs[0], last = validIrrs[validIrrs.length-1];
        growth = (((last-first)/Math.abs(first))*100).toFixed(2) + '%';
      }
      document.getElementById('extraMetricCards').innerHTML = `
        <div class="metric-card animate-fadein"><span class="metric-icon">🧮</span>Average Rate: <span class="text-yellow-300">${avg !== '-' ? avg + '%' : '-'}</span></div>
        <div class="metric-card animate-fadein"><span class="metric-icon">🚀</span>Highest Rate: <span class="text-green-300">${max !== '-' ? max + '%' : '-'}</span></div>
        <div class="metric-card animate-fadein"><span class="metric-icon">📉</span>Lowest Rate: <span class="text-red-300">${min !== '-' ? min + '%' : '-'}</span></div>
        <div class="metric-card animate-fadein"><span class="metric-icon">📊</span>Growth Rate: <span class="text-blue-300">${growth}</span></div>
      `;

      // Sortable summary table
      const labels = irrData.map((d, i) => {
        if (typeof d === 'object' && d !== null) {
          if (d.year) return `Year ${d.year}`;
          if (d.label) return d.label;
          return `Value ${i+1}`;
        } else {
          return `Value ${i+1}`;
        }
      });
      const tbody = document.getElementById('irrTable').querySelector('tbody');
      tbody.innerHTML = '';
      irrData.forEach((d, i) => {
        let value = (typeof d === 'object' && d !== null) ? d.irr : d;
        let label = labels[i];
        tbody.innerHTML += `<tr><td class="border border-white/20 px-4 py-2">${label}</td><td class="border border-white/20 px-4 py-2">${value}</td></tr>`;
      });

      // Last Updated Timestamp
      const lastUpdatedEl = document.getElementById('lastUpdated');
      const now = new Date();
      lastUpdatedEl.textContent = `Last Updated: ${now.toLocaleString()}`;

      // Bar Chart (replaces previous Radar chart)
      if(radarChart) radarChart.destroy();
      radarChart = new Chart(document.getElementById('irrRadarChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Value (%)',
            data: labels.map((_, i) => {
              let value = (typeof irrData[i] === 'object' && irrData[i] !== null) ? irrData[i].irr : irrData[i];
              let num = parseFloat(value);
              return (value !== null && value !== undefined && !isNaN(num)) ? num : 0;
            }),
            backgroundColor: colors,
            borderColor: '#60a5fa',
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e6eef8' } } },
          scales: {
            x: { ticks: { color: '#e6eef8' }, grid: { color: '#334155' } },
            y: { ticks: { color: '#e6eef8' }, grid: { color: '#334155' }, beginAtZero: true }
          }
        }
      });

      // Line Chart
      if(lineChart) lineChart.destroy();
      lineChart = new Chart(document.getElementById('irrLineChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Value (%)',
            data: labels.map((_, i) => {
              let value = (typeof irrData[i] === 'object' && irrData[i] !== null) ? irrData[i].irr : irrData[i];
              let num = parseFloat(value);
              return (value !== null && value !== undefined && !isNaN(num)) ? num : 0;
            }),
            fill: false,
            borderColor: '#34d399',
            backgroundColor: 'rgba(52,211,153,0.2)',
            tension: 0.3,
            pointBackgroundColor: colors,
            pointBorderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e6eef8' } } },
          scales: {
            x: { ticks: { color: '#e6eef8' }, grid: { color: '#334155' } },
            y: { ticks: { color: '#e6eef8' }, grid: { color: '#334155' }, beginAtZero: true }
          }
        }
      });

      // Donut Chart - use numeric values as labels so legend shows actual numbers
      if(donutChart) donutChart.destroy();
      // compute numeric dataset and formatted labels (e.g. "12.3456%")
      const donutNums = labels.map((_, i) => {
        let value = (typeof irrData[i] === 'object' && irrData[i] !== null) ? irrData[i].irr : irrData[i];
        let num = parseFloat(value);
        return (value !== null && value !== undefined && !isNaN(num)) ? num : 0;
      });
      const donutLabels = donutNums.map(n => isNaN(n) ? '0' : (Number(n).toFixed(4) + '%'));
      donutChart = new Chart(document.getElementById('irrDonutChart'), {
        type: 'doughnut',
        data: {
          labels: donutLabels,
          datasets: [{
            label: 'Value (%)',
            data: donutNums,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e6eef8' } } }
        }
      });

      // Vendor cards
      const vendorSection = document.getElementById('vendorSection');
      vendorSection.innerHTML = '';
      let vendorData = [];
      try {
        vendorData = JSON.parse(localStorage.getItem('vendorData') || '[]');
      } catch(e) {}
      if (Array.isArray(vendorData) && vendorData.length) {
        vendorSection.innerHTML = '<h2 class="text-xl font-bold mb-4 text-blue-300">Vendors</h2>' + vendorData.map(v => `
          <div class="vendor-card animate-fadein">
            <div class="font-bold text-lg">${v.name || 'Vendor'}</div>
            <div class="text-sm">${v.role ? `<span class='font-semibold'>Role:</span> ${v.role}` : ''}</div>
            <div class="text-sm">${v.price ? `<span class='font-semibold'>Price:</span> ${v.price}` : ''}</div>
            <div class="text-sm">${v.rationale ? `<span class='font-semibold'>Rationale:</span> ${v.rationale}` : ''}</div>
          </div>
        `).join('');
      }
    }

    // Assume irrValues is loaded from localStorage
    function renderIRRValues() {
      const irrValues = JSON.parse(localStorage.getItem('irrValues') || '[]');
      const container = document.getElementById('irr-list');
      if (!container) return;
      container.innerHTML = '';
      let count = 1;
      irrValues.forEach(v => {
        let label = '';
        if (v.year) {
          label = `Year ${v.year}: ${v.irr}%`;
        } else if (v.label) {
          label = `${v.label}: ${v.irr}%`;
        } else {
          label = `Value ${count}: ${v.irr}%`;
          count++;
        }
        const div = document.createElement('div');
        div.textContent = label;
        container.appendChild(div);
      });
    }

  // On load, try to read IRR data from localStorage
  let irrDataReceived = false;
  let currentSort = { col: null, asc: true };
  function updateDashboardFromStorage() {
    const storedIrr = localStorage.getItem('irrValues');
    if (storedIrr) {
      try {
        const irrArray = JSON.parse(storedIrr);
        if (Array.isArray(irrArray) && irrArray.length) {
          irrDataReceived = true;
          renderDashboard(irrArray);
        }
      } catch(e) { console.error('Failed to parse IRR data from localStorage', e); }
    }
    if (!irrDataReceived) {
      document.getElementById('irrMetricCards').innerHTML = '<div class="metric-card">Waiting for IRR data...</div>';
      document.getElementById('extraMetricCards').innerHTML = '';
      const ctx = document.getElementById('irrRadarChart').getContext('2d');
      ctx.clearRect(0,0,400,200);
    }
  }
  updateDashboardFromStorage();
  // Listen for localStorage changes (auto-update dashboard)
  window.addEventListener('storage', function(event) {
    if (event.key === 'irrValues') {
      updateDashboardFromStorage();
    }
  });
  // Sort table columns
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('sortLabel').addEventListener('click', () => {
      sortTable('label');
    });
    document.getElementById('sortIRR').addEventListener('click', () => {
      sortTable('irr');
    });
  });
  function sortTable(col) {
    const storedIrr = localStorage.getItem('irrValues');
    if (!storedIrr) return;
    let irrArray = JSON.parse(storedIrr);
    if (col === currentSort.col) currentSort.asc = !currentSort.asc;
    else currentSort = { col, asc: true };
    irrArray.sort((a, b) => {
      if (col === 'label') {
        const labelA = a.year ? `Year ${a.year}` : (a.label || '');
        const labelB = b.year ? `Year ${b.year}` : (b.label || '');
        return currentSort.asc ? labelA.localeCompare(labelB) : labelB.localeCompare(labelA);
      } else if (col === 'irr') {
        const numA = parseFloat(a.irr);
        const numB = parseFloat(b.irr);
        return currentSort.asc ? numA - numB : numB - numA;
      }
      return 0;
    });
    renderDashboard(irrArray);
  }
  </script>
</body>
</html>
